<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>绿泡泡公众号图文编辑器</title>
    <!-- 使用最新版本的html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        .header h1{
            margin-left: 20px;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.5);
            font-size: 50px;
            text-align: center;
        }
        .editor-container {
            margin: 20px;
            background-color: #168ef0;
            width: 657px;
            display: block;
        }
        .controls button{
            margin-bottom: 10px;
            margin-left: 20px;
            width: 150px;
            height: 50px;
            border-style: none;
            background-color: #168ef0;
            color: white;
            font-size: 20px;
            border-radius: 5px;
        }
        .controls{
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        button{
            padding: 6px 12px;
            margin-right: 10px;
            cursor: pointer;
        }
        .editor{
            width: 600px;
            min-height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            line-height: 1.5;
            word-wrap: break-word;
            background-color: white;
            margin: 1rem 1rem;
            margin-bottom: 10px;
            font-size: 22px;
        }
        .firstimg{
            width: 658px;
            min-height: 300px;
            border: 1px solid #ccc;
            line-height: 1.5;
            word-wrap: break-word;
            background-color: white;
            margin: 1rem 0rem;
            padding: 0;
            margin: 0;
            display: block;
            border-style: none;
        }
        .editor p{
            margin: 0 0 10px 0;
            text-indent: 2em;
            font-size: 22px;
        }
        .editor img{
            max-width: 100%;
            height: auto;
        }
        .firstimg img{
            width: 100%;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0;
            padding: 0;
            border: none;
        }
        .blue{
            min-height: 10px;
            white-space: normal;
            padding: 10px;
            word-break: break-word;
            font-size: 20px;
            color: white;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>图文编辑器</h1>
        </div>
        <div class="controls">
            <button id="addTextBtn">添加文字</button>
            <button id="addFirstimgBtn">添加标头图片</button>
            <button id="addImageBtn">添加图片</button>
            <button id="outputfile">导出图片</button>
            <button id="savefile">保存内容</button>
            <button id="clearfile">清除内容</button>
        </div>
    </div>
    <div class="editor-container">
        <div class="firstimg"  contenteditable="true"></div>
        <div class="editor" contenteditable="true">
            <p style="text-indent: 2em;">开始输入</p>
        </div>
        <div class="blue" contenteditable="true"></div>
    </div>

    <script>
        const editor = document.querySelector('.editor');
        const firstimgContainer = document.querySelector('.firstimg');
        const blueContainer = document.querySelector('.blue');
        const addTextBtn = document.getElementById('addTextBtn');
        const addImageBtn = document.getElementById('addImageBtn');
        const addFirstimgBtn = document.getElementById('addFirstimgBtn');
        const savefileBtn = document.getElementById('savefile');
        const clearfileBtn = document.getElementById('clearfile');

        function loadContent() {
            const savedContent = localStorage.getItem('editorContent');
            const savedFirstImg = localStorage.getItem('firstImgContent');
            const savedBlueContent = localStorage.getItem('blueContent');
            
            if (savedFirstImg) {
                firstimgContainer.innerHTML = savedFirstImg;
            }
            if (savedContent) {
                editor.innerHTML = savedContent;
            }
            if (savedBlueContent) {
                blueContainer.innerHTML = savedBlueContent;
            }
        }

        function saveContent() {
            localStorage.setItem('editorContent', editor.innerHTML);
            localStorage.setItem('firstImgContent', firstimgContainer.innerHTML);
            localStorage.setItem('blueContent', blueContainer.innerHTML);
            alert('内容已保存！');
        }

        function clearContent() {
            if (confirm('确定要清除所有内容吗？')) {
                editor.innerHTML = '';
                firstimgContainer.innerHTML = '';
                blueContainer.innerHTML = '';
                localStorage.removeItem('editorContent');
                localStorage.removeItem('firstImgContent');
                localStorage.removeItem('blueContent');
            }
        }

        window.addEventListener('load', loadContent);

        addTextBtn.addEventListener('click', () => {
            const text = prompt('请输入要添加的文字：');
            if (text !== null && text !== '') {
                const p = document.createElement('p');
                p.textContent = text;
                editor.appendChild(p);
                const range = document.createRange();
                const sel = window.getSelection();
                range.setStartAfter(p);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        });

        addImageBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.crossOrigin = 'anonymous';
                        editor.appendChild(img);
                        const p = document.createElement('p');
                        p.innerHTML = '&nbsp;';
                        editor.appendChild(p);
                    };
                    reader.readAsDataURL(file);
                }
            });

            input.click();
        });

        addFirstimgBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        firstimgContainer.innerHTML = ''
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.crossOrigin = 'anonymous';
                        firstimgContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });

            input.click();
        });

        savefileBtn.addEventListener('click', saveContent);

        clearfileBtn.addEventListener('click', clearContent);

        const outputfileBtn = document.getElementById('outputfile');
        outputfileBtn.addEventListener('click', () => {
            const container = document.querySelector('.editor-container');
            
            html2canvas(container, {
                useCORS: true,
                logging: true,
                scale: 2,
                allowTaint: false,
                backgroundColor: null,
                windowWidth: container.scrollWidth,
                windowHeight: container.scrollHeight
            }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = '导出公众号图片.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).catch(error => {
                console.error('导出失败:', error);
                alert('导出图片失败，请重试！错误信息：' + error.message);
            });
        });
    </script>
</body>
</html>