<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>绿泡泡公众号图文工坊</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="twbj.css" type="text/CSS">
</head>
<body>
    <div class="header">
        <div>
            <h1><b>图文编辑工坊</b></h1>
        </div>
        <div class="controls">
            <button id="newtask">新建任务</button>
            <button id="addFirstimgBtn">添加标头图片</button>
            <button id="addTextBtn">添加文字</button>
            <button id="addImageBtn">添加正文图片</button>
            <button id="outputfile">导出图片</button>
            <button id="savefile">保存内容</button>
            <button id="clearfile">清除内容</button>
            <button id="cleartask">删除任务</button>
        </div>
    </div>
    <div class="main">
        <div class="task">
            <h3>历史任务</h3>
            <div id="taskList"></div>
        </div>
        <div class="editwindow">
            <div class="edityangshi">
                字号：
                <select name="zihao" id="zihao">
                    <option></option>
                    <option>10</option>
                    <option>12</option>
                    <option>14</option>
                    <option>16</option>
                    <option>18</option>
                    <option>20</option>
                    <option>22</option>
                    <option>24</option>
                    <option>26</option>
                    <option>28</option>
                    <option>30</option>
                    <option>32</option>
                    <option>34</option>
                    <option>36</option>
                    <option>38</option>
                </select>
                <div class="color-controls">
                    <div class="color-item">
                        背景色：
                        <input type="color" id="bgColorPicker" value="#ffffff">
                    </div>
                    <div class="color-item">
                        文字色：
                        <input type="color" id="textColorPicker" value="#000000">
                    </div>
                </div>
                字体：
                <select name="fontFamily" id="fontFamily">
                    <option value=""></option>
                    <option value="SimSun">宋体</option>
                    <option value="SimHei">黑体</option>
                    <option value="KaiTi">楷体</option>
                    <option value="FangSong">仿宋</option>
                </select>

                <div class="font-style-controls">
                    <button id="boldBtn" title="粗体"><b>B</b></button>
                    <button id="italicBtn" title="斜体"><i><b>I</b></i></button>
                    <button id="underlineBtn" title="下划线"><u>U</u></button>
                    <button id="strikeBtn" title="删除线"><s>S</s></button>
                    <button id="formatPainter" title="格式刷">格式刷</button>
                </div>

                <div class="align-controls">
                    <button id="leftAlignBtn" title="左对齐">左对齐</button>
                    <button id="centerAlignBtn" title="居中">居中</button>
                    <button id="rightAlignBtn" title="右对齐">右对齐</button>
                    <button id="justifyAlignBtn" title="两端">两端</button>
                </div>

                <div class="image-layout-controls">
                    图片布局：
                    <button id="singleImageBtn" class="active">单列</button>
                    <button id="sideBySideBtn">并排</button>
                </div>

                <div id="imageSizeControls" class="imageSizeControls">
                    图片尺寸：
                    宽：<input type="number" id="imgWidth" min="10" step="10">
                    高：<input type="number" id="imgHeight" min="10" step="10">
                    <label><input type="checkbox" id="lockAspectRatio" checked> 锁定比例</label>
                </div>
            </div>
            <div class="textpic">
                <div class="editor-container">
                    <div class="firstimg"  contenteditable="true"></div>
                    <div class="editor" contenteditable="true"></div>
                    <div class="blue" contenteditable="true"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="textModal" class="textModal">
        <div class="textwindow">
            <h3>编辑文字内容</h3>
            <textarea id="textInput" class="textInput"></textarea>
            <div class="textBtn">
                <button id="confirmTextBtn" class="confirmTextBtn">确定</button>
                <button id="cancelTextBtn" class="cancelTextBtn">取消</button>
            </div>
        </div>
    </div>
    <div class="footer">
        © 2025 Graphic and Text Editing | Make official account creation easier
    </div>
    

    <script>
        const editor = document.querySelector('.editor');
        const firstimgContainer = document.querySelector('.firstimg');
        const blueContainer = document.querySelector('.blue');
        const addTextBtn = document.getElementById('addTextBtn');
        const addImageBtn = document.getElementById('addImageBtn');
        const addFirstimgBtn = document.getElementById('addFirstimgBtn');
        const savefileBtn = document.getElementById('savefile');
        const clearfileBtn = document.getElementById('clearfile');
        const taskList = document.getElementById('taskList');
        const textModal = document.getElementById('textModal');
        const textInput = document.getElementById('textInput');
        const confirmTextBtn = document.getElementById('confirmTextBtn');
        const cancelTextBtn = document.getElementById('cancelTextBtn');
        const zihaoSelect = document.getElementById('zihao');
        const bgColorPicker = document.getElementById('bgColorPicker');
        const textColorPicker = document.getElementById('textColorPicker');
        const textpic = document.querySelector('.textpic');
        const editorContainer = document.querySelector('.editor-container');
        const fontFamilySelect = document.getElementById('fontFamily');
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const underlineBtn = document.getElementById('underlineBtn');
        const strikeBtn = document.getElementById('strikeBtn');
        const leftAlignBtn = document.getElementById('leftAlignBtn');
        const centerAlignBtn = document.getElementById('centerAlignBtn');
        const rightAlignBtn = document.getElementById('rightAlignBtn');
        const justifyAlignBtn = document.getElementById('justifyAlignBtn');
        const imageSizeControls = document.getElementById('imageSizeControls');
        const imgWidth = document.getElementById('imgWidth');
        const imgHeight = document.getElementById('imgHeight');
        const lockAspectRatio = document.getElementById('lockAspectRatio');
        const singleImageBtn = document.getElementById('singleImageBtn');
        const sideBySideBtn = document.getElementById('sideBySideBtn');
        
        let imageLayout = 'single';
        let pendingImage = null;

        const formatPainter = document.getElementById('formatPainter');
        let copiedStyles = null;
        let isContinuousMode = false;
        let selectedImage = null;
        let imageAspectRatio = 1;

        let currentTask = null;

        function init() {
            loadTaskList();
            setupEventListeners();

            editor.style.textAlign = 'justify';
            justifyAlignBtn.classList.add('active');
        }

        function setupEventListeners() {
            zihaoSelect.addEventListener('change', applyFontSize);
            
            document.addEventListener('selectionchange', updateFontSizeSelection);
            
            bgColorPicker.addEventListener('input', (e) => {
                editorContainer.style.backgroundColor = e.target.value;
                blueContainer.style.backgroundColor = e.target.value;
            });
            
            textColorPicker.addEventListener('input', applyTextColor);
            
            editor.addEventListener('input', handleEditorInput);

            fontFamilySelect.addEventListener('change', applyFontFamily);

            document.addEventListener('selectionchange', updateFontFamilySelection);

            document.addEventListener('selectionchange', updateBoldButtonState);

            boldBtn.addEventListener('click', () => {
                document.execCommand('bold', false, null);
                document.dispatchEvent(new Event('selectionchange'));
            });

            document.addEventListener('selectionchange', updateItalicButtonState);

            italicBtn.addEventListener('click', () => {
                document.execCommand('italic', false, null);
                document.dispatchEvent(new Event('selectionchange'));
            });

            document.addEventListener('selectionchange', updateUnderlineButtonState);

            underlineBtn.addEventListener('click', () => {
                document.execCommand('underline', false, null);
                document.dispatchEvent(new Event('selectionchange'));
            });

            document.addEventListener('selectionchange', updateStrikeButtonState);

            strikeBtn.addEventListener('click', () => {
                document.execCommand('strikeThrough', false, null);
                document.dispatchEvent(new Event('selectionchange'));
            });

            document.addEventListener('selectionchange', updateLeftAlignButtonState);

            leftAlignBtn.addEventListener('click', () => {
                document.execCommand('justifyLeft', false, null);
                document.dispatchEvent(new Event('selectionchange'));
            });

            document.addEventListener('selectionchange', updateCenterAlignButtonState);

            centerAlignBtn.addEventListener('click', () =>{
                document.execCommand('justifyCenter', false, null);
                document.dispatchEvent(new Event('selectionchange'));
            });

            document.addEventListener('selectionchange', updateRightAlignButtonState);

            rightAlignBtn.addEventListener('click', () =>{
                document.execCommand('justifyRight', false, null);
                document.dispatchEvent(new Event('selectionchange'));
            });

            document.addEventListener('selectionchange', updateJustifyAlignButtonState);

            justifyAlignBtn.addEventListener('click', () =>{
                document.execCommand('justifyFull', false, null);
                document.dispatchEvent(new Event('selectionchange'));
            });

            editor.addEventListener('click', handleImageSelection);
            firstimgContainer.addEventListener('click', handleImageSelection);

            imgWidth.addEventListener('input', handleImageDimensionChange);
            imgHeight.addEventListener('input', handleImageDimensionChange);

            setupFormatPainter();

            singleImageBtn.addEventListener('click', () => {
                imageLayout = 'single';
                singleImageBtn.classList.add('active');
                sideBySideBtn.classList.remove('active');
                pendingImage = null;
            });

            sideBySideBtn.addEventListener('click', () => {
                imageLayout = 'sideBySide';
                sideBySideBtn.classList.add('active');
                singleImageBtn.classList.remove('active');
            });

            document.querySelectorAll('.preset-color[data-color]').forEach(item => {
                item.addEventListener('click', (e) => {
                    const color = e.target.dataset.color;
                    bgColorPicker.value = color;
                    editorContainer.style.backgroundColor = color;
                    blueContainer.style.backgroundColor = color;
                });
            });
        }

        function setupFormatPainter() {
            let clickCount = 0;
            let clickTimer = null;

            formatPainter.addEventListener('click', (e) => {
                e.preventDefault();
                clickCount++;

                if (clickCount === 1) {
                    clickTimer = setTimeout(() => {
                        handleSingleClick();
                        clickCount = 0;
                    }, 300);
                } else if (clickCount === 2) {
                    clearTimeout(clickTimer);
                    handleDoubleClick();
                    clickCount = 0;
                }
            });

            function handleSingleClick() {
                if (copiedStyles && !isContinuousMode) {
                    copiedStyles = null;
                    formatPainter.classList.remove('active');
                    document.removeEventListener('mouseup', applyCopiedStyles);
                } else {
                    copiedStyles = copySelectedStyles();
                    if (copiedStyles) {
                        formatPainter.classList.add('active');
                        document.addEventListener('mouseup', applyOnceHandler);
                    }
                }
            }

            function handleDoubleClick() {
                copiedStyles = copySelectedStyles();
                if (copiedStyles) {
                    isContinuousMode = true;
                    formatPainter.classList.add('active');
                    document.addEventListener('mouseup', applyCopiedStyles);
                }
            }

            function applyOnceHandler(e) {
                if (e.target.closest('[contenteditable="true"]')) {
                    applyCopiedStyles(e);
                    copiedStyles = null;
                    formatPainter.classList.remove('active');
                    document.removeEventListener('mouseup', applyOnceHandler);
                }
            }
        }

        function copySelectedStyles() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0 || selection.isCollapsed) {
                alert('请先选中要复制格式的内容');
                return null;
            }

            const range = selection.getRangeAt(0);
            let element = range.commonAncestorContainer;
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentElement;
            }

            const computed = window.getComputedStyle(element);
            
            const textDecoration = computed.textDecoration;
            const hasUnderline = textDecoration.includes('underline');
            const hasStrike = textDecoration.includes('line-through');
            
            return {
                fontSize: computed.fontSize,
                fontFamily: computed.fontFamily,
                color: computed.color,
                fontWeight: computed.fontWeight,
                fontStyle: computed.fontStyle,
                textAlign: computed.textAlign,
                hasUnderline: hasUnderline,
                hasStrike: hasStrike
            };
        }

        function applyCopiedStyles(e) {
            if (!copiedStyles) return;
            
            if (!e.target.closest('[contenteditable="true"]')) return;

            const selection = window.getSelection();
            if (selection.rangeCount === 0 || selection.isCollapsed) return;

            document.execCommand('styleWithCSS', false, true);
            
            if (copiedStyles.fontSize) {
                document.execCommand('fontSize', false, '');
                const size = parseInt(copiedStyles.fontSize);
                const span = document.createElement('span');
                span.style.fontSize = copiedStyles.fontSize;
                span.appendChild(selection.getRangeAt(0).extractContents());
                selection.getRangeAt(0).insertNode(span);
            }
            
            if (copiedStyles.fontFamily) {
                document.execCommand('fontName', false, copiedStyles.fontFamily);
            }
            
            if (copiedStyles.color) {
                document.execCommand('foreColor', false, copiedStyles.color);
            }
            
            if (copiedStyles.fontWeight === 'bold' || copiedStyles.fontWeight === '700') {
                document.execCommand('bold', false, null);
            }
            
            if (copiedStyles.fontStyle === 'italic') {
                document.execCommand('italic', false, null);
            }
            
            if (copiedStyles.hasUnderline) {
                document.execCommand('underline', false, null);
            }

            if (copiedStyles.hasStrike) {
                document.execCommand('strikeThrough', false, null);
            } 

            
            if (copiedStyles.textAlign === 'left') {
                document.execCommand('justifyLeft', false, null);
            } else if (copiedStyles.textAlign === 'center') {
                document.execCommand('justifyCenter', false, null);
            } else if (copiedStyles.textAlign === 'right') {
                document.execCommand('justifyRight', false, null);
            } else if (copiedStyles.textAlign === 'justify') {
                document.execCommand('justifyFull', false, null);
            }
            
            document.execCommand('styleWithCSS', false, false);
            
            if (!isContinuousMode) {
                copiedStyles = null;
                formatPainter.classList.remove('active');
                document.removeEventListener('mouseup', applyCopiedStyles);
            }
        }

        function updateFontSizeSelection() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                return;
            }

            const range = selection.getRangeAt(0);
            let element = range.commonAncestorContainer;
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentElement;
            }

            const computedStyle = window.getComputedStyle(element);
            const fontSize = computedStyle.fontSize;
            const size = parseInt(fontSize, 10);

            if (!isNaN(size)) {
                zihaoSelect.value = size;
            } else {
                zihaoSelect.value = '';
            }
        }

        function applyFontSize() {
            const fontSize = zihaoSelect.value;
            if (!fontSize) return;

            const sizeToApply = `${fontSize}px`;
            const selection = window.getSelection();
            
            if (selection.rangeCount > 0) {
                if (!selection.isCollapsed) {
                    document.execCommand('fontSize', false, '');
                    const span = document.createElement('span');
                    span.style.fontSize = sizeToApply;
                    span.appendChild(selection.getRangeAt(0).extractContents());
                    selection.getRangeAt(0).insertNode(span);
                } else {
                    const style = document.createElement('style');
                    style.type = 'text/css';
                    style.textContent = `
                        [contenteditable=true]:empty:before {
                            font-size: ${sizeToApply};
                        }
                    `;
                    document.head.appendChild(style);
                    setTimeout(() => document.head.removeChild(style), 0);
                    
                    document.execCommand('styleWithCSS', false, true);
                    document.execCommand('fontSize', false, '');
                    document.execCommand('foreColor', false, textColorPicker.value);
                }
            }
        }

        function applyTextColor() {
            const color = textColorPicker.value;
            document.execCommand('foreColor', false, color);
        }

        function handleEditorInput() {
        }

        function getTasks() {
            const tasks = localStorage.getItem('editorTasks');
            return tasks ? JSON.parse(tasks) : [];
        }

        function saveTasks(tasks) {
            localStorage.setItem('editorTasks', JSON.stringify(tasks));
        }

        function loadTaskList() {
            const tasks = getTasks();
            taskList.innerHTML = '';
            
            tasks.forEach(taskName => {
                const btn = document.createElement('button');
                btn.className = `task-btn ${currentTask === taskName ? 'active' : ''}`;
                btn.textContent = taskName;
                btn.addEventListener('click', () => {
                    loadTaskContent(taskName);
                });
                taskList.appendChild(btn);
            });
        }

        function loadTaskContent(taskName) {
            const taskData = localStorage.getItem(`task_${taskName}`);
            if (taskData) {
                const { firstImg, content, blue, bgColor, textColor, fontSize } = JSON.parse(taskData);
                firstimgContainer.innerHTML = firstImg;
                editor.innerHTML = content;
                blueContainer.innerHTML = blue;
                
                if (bgColor) {
                    textpic.style.backgroundColor = bgColor;
                    bgColorPicker.value = bgColor;
                } else {
                    textpic.style.backgroundColor = '#ffffff';
                    bgColorPicker.value = '#ffffff';
                }
                
                if (textColor) {
                    textColorPicker.value = textColor;
                } else {
                    textColorPicker.value = '#000000';
                }
                
                if (fontSize) {
                    zihaoSelect.value = fontSize;
                } else {
                    zihaoSelect.value = '';
                }
                
                currentTask = taskName;
                document.querySelectorAll('.task-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent === taskName);
                });
            }
        }

        function saveTaskContent(taskName, isNew = false) {
            const taskData = {
                firstImg: firstimgContainer.innerHTML,
                content: editor.innerHTML,
                blue: blueContainer.innerHTML,
                timestamp: new Date().getTime(),
                bgColor: textpic.style.backgroundColor,
                textColor: textColorPicker.value,
                fontSize: zihaoSelect.value
            };

            localStorage.setItem(`task_${taskName}`, JSON.stringify(taskData));
            
            if (isNew) {
                const tasks = getTasks();
                if (!tasks.includes(taskName)) {
                    tasks.unshift(taskName);
                    saveTasks(tasks);
                }
            }
            
            currentTask = taskName;
            loadTaskList();
            alert(`任务 "${taskName}" 已保存！`);
        }

        function handleSaveTask() {
            if (currentTask) {
                if (confirm(`是否覆盖当前任务 "${currentTask}"？`)) {
                    saveTaskContent(currentTask, false);
                } else {
                    const newTaskName = prompt('请输入新任务名称：');
                    if (newTaskName && newTaskName.trim() !== '') {
                        saveTaskContent(newTaskName.trim(), true);
                    }
                }
            } else {
                const taskName = prompt('请输入任务名称：');
                if (taskName && taskName.trim() !== '') {
                    saveTaskContent(taskName.trim(), true);
                }
            }
        }

        function clearContent() {
            if (confirm('确定要清除所有内容吗？')) {
                editor.innerHTML = '';
                firstimgContainer.innerHTML = '';
                blueContainer.innerHTML = '';
                textpic.style.backgroundColor = '#ffffff';
                bgColorPicker.value = '#ffffff';
                textColorPicker.value = '#000000';
                zihaoSelect.value = '';
                
                currentTask = null;
                document.querySelectorAll('.task-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                pendingImage = null;
            }
        }

        window.addEventListener('load', init);

        addTextBtn.addEventListener('click', () => {
            textInput.value = ''; 
            textModal.style.display = 'flex'; 
            textInput.focus(); 
        });

        cancelTextBtn.addEventListener('click', () => {
            textModal.style.display = 'none';
        });

        confirmTextBtn.addEventListener('click', () => {
            const text = textInput.value.trim();
            if (text) {
                const p = document.createElement('p');
                p.textContent = text;
                const fontSize = zihaoSelect.value;
                if (fontSize) {
                    p.style.fontSize = `${fontSize}px`;
                }
                p.style.color = textColorPicker.value;
                editor.appendChild(p);
                const range = document.createRange();
                const sel = window.getSelection();
                range.setStartAfter(p);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
            textModal.style.display = 'none';
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && textModal.style.display === 'flex') {
                textModal.style.display = 'none';
            }
        });

        textModal.addEventListener('click', (e) => {
            if (e.target === textModal) {
                textModal.style.display = 'none';
            }
        });

        addImageBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.crossOrigin = 'anonymous';
                        img.style.display = 'block';
                        img.style.margin = '0 auto';

                        if (imageLayout === 'sideBySide') {
                            if (pendingImage) {
                                const container = document.createElement('div');
                                container.className = 'image-container';
                                
                                container.appendChild(pendingImage);
                                container.appendChild(img);
                                
                                editor.appendChild(container);
                                
                                const p = document.createElement('p');
                                p.innerHTML = '&nbsp;';
                                const fontSize = zihaoSelect.value;
                                if (fontSize) {
                                    p.style.fontSize = `${fontSize}px`;
                                }
                                editor.appendChild(p);
                                
                                pendingImage = null;
                            } else {
                                pendingImage = img;
                                alert('请再选择一张图片以并排显示');
                            }
                        } else {
                            editor.appendChild(img);
                            const p = document.createElement('p');
                            p.innerHTML = '&nbsp;';
                            const fontSize = zihaoSelect.value;
                            if (fontSize) {
                                p.style.fontSize = `${fontSize}px`;
                            }
                            editor.appendChild(p);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });

            input.click();
        });

        addFirstimgBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        firstimgContainer.innerHTML = ''
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.crossOrigin = 'anonymous';
                        img.style.display = 'block';
                        img.style.margin = '0 auto';
                        firstimgContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });

            input.click();
        });

        savefileBtn.addEventListener('click', handleSaveTask);
        clearfileBtn.addEventListener('click', clearContent);

        const outputfileBtn = document.getElementById('outputfile');
        outputfileBtn.addEventListener('click', () => {
            const container = document.querySelector('.editor-container');
            
            html2canvas(container, {
                useCORS: true,
                logging: true,
                scale: 2,
                allowTaint: false,
                backgroundColor: null,
                windowWidth: container.scrollWidth,
                windowHeight: container.scrollHeight
            }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = currentTask ? `${currentTask}.png` : '导出公众号图片.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).catch(error => {
                console.error('导出失败:', error);
                alert('导出图片失败，请重试！错误信息：' + error.message);
            });
        });

        const newTaskBtn = document.getElementById('newtask');

        newTaskBtn.addEventListener('click', () => {
            const taskName = prompt('请输入新任务名称：');

            if (taskName && taskName.trim() !== '') {
                const trimmedName = taskName.trim();
                const tasks = getTasks();

                if (tasks.includes(trimmedName)) {
                    alert(`任务 "${trimmedName}" 已存在，请使用其他名称！`);
                    return;
                }

                editor.innerHTML = '';
                firstimgContainer.innerHTML = '';
                blueContainer.innerHTML = '';
                textpic.style.backgroundColor = '#ffffff';
                bgColorPicker.value = '#ffffff';
                textColorPicker.value = '#000000';
                zihaoSelect.value = '';
                pendingImage = null;

                saveTaskContent(trimmedName, true);

                loadTaskContent(trimmedName);
            } else if (taskName !== null) {

                alert('任务名称不能为空！');
            }
        });

        const cleartaskBtn = document.getElementById('cleartask');

        cleartaskBtn.addEventListener('click', () => {
            if (!currentTask) {
                alert('没有选中的任务可删除！');
                return;
            }

            if (confirm(`确定要删除当前任务 "${currentTask}" 吗？此操作不可恢复！`)) {
                localStorage.removeItem(`task_${currentTask}`);

                const tasks = getTasks();
                const updatedTasks = tasks.filter(task => task !== currentTask);
                saveTasks(updatedTasks);

                editor.innerHTML = '';
                firstimgContainer.innerHTML = '';
                blueContainer.innerHTML = '';
                textpic.style.backgroundColor = '#ffffff';
                bgColorPicker.value = '#ffffff';
                textColorPicker.value = '#000000';
                zihaoSelect.value = '';
                pendingImage = null;

                currentTask = null;

                loadTaskList();

                alert(`任务已成功删除！`);
            }
        });

        function updateFontFamilySelection() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                return;
            }

            const range = selection.getRangeAt(0);
            let element = range.commonAncestorContainer;
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentElement;
            }

            const computedStyle = window.getComputedStyle(element);
            const fontFamily = computedStyle.fontFamily;
            const family = fontFamily.split(',')[0].replace(/['"]/g, '').trim();

            if (family) {
                fontFamilySelect.value = family;
            } else {
                fontFamilySelect.value = '';
            }
        }

        function applyFontFamily() {
            const fontFamily = fontFamilySelect.value;
            if (fontFamily) {
                document.execCommand('fontName', false, fontFamily);
            }
        }

        function handleImageSelection(e) {
            if (e.target.tagName === 'IMG') {
                selectedImage = e.target;
                selectedImage.style.display = 'block';
                selectedImage.style.margin = '0 auto';
                imageSizeControls.style.display = 'flex';
                imgWidth.value = Math.round(selectedImage.offsetWidth);
                imgHeight.value = Math.round(selectedImage.offsetHeight);
                imageAspectRatio = selectedImage.offsetWidth / selectedImage.offsetHeight;
            } else {
                selectedImage = null;
                imageSizeControls.style.display = 'none';
            }
        }

        function handleImageDimensionChange(e) {
            if (!selectedImage) return;

            e.stopPropagation();
            
            const width = parseInt(imgWidth.value, 10);
            const height = parseInt(imgHeight.value, 10);
            
            if (isNaN(width) || isNaN(height)) return;

            if (lockAspectRatio.checked) {
                if (e.target === imgWidth) {
                    imgHeight.value = Math.round(width / imageAspectRatio);
                    selectedImage.style.height = `${width / imageAspectRatio}px`;
                } else {
                    imgWidth.value = Math.round(height * imageAspectRatio);
                    selectedImage.style.width = `${height * imageAspectRatio}px`;
                }
            }

            selectedImage.style.width = `${width}px`;
            selectedImage.style.height = `${height}px`;
            
            selectedImage.style.display = 'block';
            selectedImage.style.margin = '0 auto';
        }

        function updateBoldButtonState() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                boldBtn.classList.remove('active');
                return;
            }

            let element = selection.getRangeAt(0).commonAncestorContainer;
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentElement;
            }

            const isBold = window.getComputedStyle(element).fontWeight === 'bold' 
                || window.getComputedStyle(element).fontWeight === '700';

            if (isBold) {
                boldBtn.classList.add('active');
            } else {
                boldBtn.classList.remove('active');
            }
        }

        function updateItalicButtonState() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                italicBtn.classList.remove('active');
                return;
            }

            let element = selection.getRangeAt(0).commonAncestorContainer;
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentElement;
            }

            const isItalic = window.getComputedStyle(element).fontStyle === 'italic';
            
            if (isItalic) {
                italicBtn.classList.add('active');
            } else {
                italicBtn.classList.remove('active');
            }
        }

        function updateUnderlineButtonState() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                underlineBtn.classList.remove('active');
                return;
            }

            let element = selection.getRangeAt(0).commonAncestorContainer;
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentElement;
            }

            const isUnderline = window.getComputedStyle(element).textDecoration.includes('underline');

            if (isUnderline) {
                underlineBtn.classList.add('active');
            } else {
                underlineBtn.classList.remove('active');
            }
        }

        function updateStrikeButtonState() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                strikeBtn.classList.remove('active');
                return;
            }

            let element = selection.getRangeAt(0).commonAncestorContainer;
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentElement;
            }

            const isStrike = window.getComputedStyle(element).textDecoration.includes('line-through');

            if (isStrike) {
                strikeBtn.classList.add('active');
            } else {
                strikeBtn.classList.remove('active');
            }
        }

        function updateLeftAlignButtonState() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                strikeBtn.classList.remove('active');
                return;
            }

            let element = selection.getRangeAt(0).commonAncestorContainer;
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentElement;
            }

            let targetElement = element;
            while (targetElement && targetElement !== document.body) {
                const display = window.getComputedStyle(targetElement).display;
                if (display.includes('block') || display.includes('flex') || display.includes('grid')) {
                    break;
                }
                targetElement = targetElement.parentElement;
            }

            const textAlign = window.getComputedStyle(targetElement).textAlign;
            const isLeftAligned = textAlign === 'left' || textAlign === 'start';

            if (isLeftAligned) {
                leftAlignBtn.classList.add('active');
            } else {
                leftAlignBtn.classList.remove('active');
            }
        }

        function updateCenterAlignButtonState() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                strikeBtn.classList.remove('active');
                return;
            }

            let element = selection.getRangeAt(0).commonAncestorContainer;
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentElement;
            }

            let targetElement = element;
            while (targetElement && targetElement !== document.body) {
                const display = window.getComputedStyle(targetElement).display;
                if (display.includes('block') || display.includes('flex') || display.includes('grid')) {
                    break;
                }
                targetElement = targetElement.parentElement;
            }

            const textAlign = window.getComputedStyle(targetElement).textAlign;
            const isCenterAligned = textAlign === 'center';

            if (isCenterAligned) {
                centerAlignBtn.classList.add('active');
            } else {
                centerAlignBtn.classList.remove('active');
            }
        }

        function updateRightAlignButtonState() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                strikeBtn.classList.remove('active');
                return;
            }

            let element = selection.getRangeAt(0).commonAncestorContainer;
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentElement;
            }

            let targetElement = element;
            while (targetElement && targetElement !== document.body) {
                const display = window.getComputedStyle(targetElement).display;
                if (display.includes('block') || display.includes('flex') || display.includes('grid')) {
                    break;
                }
                targetElement = targetElement.parentElement;
            }

            const textAlign = window.getComputedStyle(targetElement).textAlign;
            const isRightAligned = textAlign === 'right' || textAlign === 'end';

            if (isRightAligned) {
                rightAlignBtn.classList.add('active');
            } else {
                rightAlignBtn.classList.remove('active');
            }
        }

        function updateJustifyAlignButtonState() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                strikeBtn.classList.remove('active');
                return;
            }

            let element = selection.getRangeAt(0).commonAncestorContainer;
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentElement;
            }

            let targetElement = element;
            while (targetElement && targetElement !== document.body) {
                const display = window.getComputedStyle(targetElement).display;
                if (display.includes('block') || display.includes('flex') || display.includes('grid')) {
                    break;
                }
                targetElement = targetElement.parentElement;
            }

            const textAlign = window.getComputedStyle(targetElement).textAlign;
            const isJustifyAligned = textAlign === 'justify';

            if (isJustifyAligned) {
                justifyAlignBtn.classList.add('active');
            } else {
                justifyAlignBtn.classList.remove('active');
            }
        }
    </script>
</body>
</html>
